#!/usr/bin/env bash
# Intended to be executed in a Bash shell.
[[ -n "${BO_Trace}" ]] && 1>&2 echo "Executing ${BASH_SOURCE}" && [[ "${BO_Trace}" != 'TRACE' ]] && set -vx
# NO: set -e
# NO: trap ... EXIT
###############################################################################
# TODO: backup original Bash scripts
# TODO: copy files into place on new workstation (separate script?)
[[ -z "${BO_Project}" ]] &&
    1>&2 echo "ERROR: Aborting, this project is NOT ACTIVATED" &&
    exit 99

preferred_vim() {
    # Return absolute path to my preferred Vim
    local -r PathNvim="$(which nvim)"
    local -r PathVi="$(which vi)"
    local -r PathVim="$(which vim)"

    if [[ -n "${PathNvim}" ]]; then
        echo -n "${PathNvim}"
    elif [[ -n "${PathVim}" ]]; then
        echo -n "${PathVim}"
    else
        echo -n "${PathVi}"
    fi

    return 0
}

sync_directory() {
    # Synchronize directory trees
    # TODO: REFACTOR into BriteOnyx Bash declarations
    require_arguments $# 2
    require_variable MyVim
    local -r DirTarget=$1
    local -r DirSource=$2

    if [[ -d "${DirSource}" ]] ; then
        log_info "Synchronizing directories '${DirTarget}' and '${DirSource}'"
        maybe_create_directory_tree "${DirTarget}"
        ${MyVim} -c "DirDiff ${DirTarget} ${DirSource}"
    else
        log_warn "Missing directory '${DirSource}', skipping"
    fi
}

sync_file() {
    # Synchronize file
    # TODO: REFACTOR into BriteOnyx Bash declarations
    require_arguments $# 3
    require_variable MyVim
    local -r DirTarget=$1
    local -r DirSource=$2
    local -r File=$3

    if [[ -f "${DirSource}/${File}" ]] ; then
        log_info "Synchronizing files '${DirTarget}/${File}' and '${DirSource}/${File}'"
        maybe_create_directory_tree "${DirTarget}"
        ${MyVim} -d "${DirTarget}/${File}" "${DirSource}/${File}"
    else
        log_warn "Missing file '${DirSource}/${File}', skipping"
    fi
}

sync_specific() {
    # Synchronize relevant files & directories
    # based on what is specific to the local workstation's operating systems
    require_arguments $# 0
    require_directory_in BO_Project
    require_directory_in HOME
    require_variable BO_OS
    local -r Dir=${BO_Project}/home/${BO_OS}

    log_info "Synchronizing workstation (${BO_OS}-specific)"

    sync_directory "${HOME}/.config" "${Dir}/.config"
    sync_directory "${HOME}/.local"  "${Dir}/.local"
    sync_directory "${HOME}/.vim"    "${Dir}/.vim"
    sync_directory "${HOME}/bin"     "${Dir}/bin"

    sync_file "${HOME}" "${Dir}" .bash_logout
    sync_file "${HOME}" "${Dir}" .bash_profile
    sync_file "${HOME}" "${Dir}" .bashrc
    sync_file "${HOME}" "${Dir}" .profile
    sync_file "${HOME}" "${Dir}" .spacemacs
    sync_file "${HOME}" "${Dir}" .vimrc
    sync_file "${HOME}" "${Dir}" alias.bash
}

main() {
    # Synchronize relevant files & directories
    # against home directory tree
    # on local workstation
    require_arguments $# 0
    local -r MyVim="$(preferred_vim)"

    sync_specific

    return 0
}

main $@

###############################################################################
# NOTE: Uncomment these lines for debugging, placed where needed
# export PS4='$ ' ; set -vx
# Code to debug...
# set +vx

: << 'DisabledContent'
sync_shared() {
    # Synchronize relevant files & directories
    # based on what is shared across operating systems
    require_arguments $# 0
    require_directory_in BO_Project
    require_directory_in HOME
    local -r Dir=${BO_Project}/home/shared

    log_info "Synchronizing workstation (non-operating-system-specific)"

    sync_directory "${HOME}/.config" "${Dir}/.config"
    sync_directory "${HOME}/.local"  "${Dir}/.local"
    sync_directory "${HOME}/.ssh"    "${Dir}/.ssh"
    sync_directory "${HOME}/.vim"    "${Dir}/.vim"
    sync_directory "${HOME}/bin"     "${Dir}/bin"

    sync_file "${HOME}" "${Dir}" .bashrc
    sync_file "${HOME}" "${Dir}" .condarc
    sync_file "${HOME}" "${Dir}" .inputrc
    sync_file "${HOME}" "${Dir}" alias.bash
}

    sync_directory "${BO_Project}/home/shared" "${BO_Project}/home/Linux"
    sync_directory "${BO_Project}/home/shared" "${BO_Project}/home/Darwin"
    sync_directory "${BO_Project}/home/Darwin" "${BO_Project}/home/Linux"
    sync_shared
DisabledContent

